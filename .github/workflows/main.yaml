name: Deploy workflow

on:
  push:
    branches:
      - main

env:
  REPOSITORY: matific/test-app

jobs:
  build-test-push:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::807181840404:role/GithubActionsOIDC-Role-XhFeMhEOphGb
        aws-region: sa-east-1

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build docker image
      run: |
        docker build -t ${{ steps.login-ecr.outputs.registry }}/$REPOSITORY:${{ github.sha }} .

    - name: Run tests
      run: |
        docker run -e REQUIRED_SETTING=foo ${{ steps.login-ecr.outputs.registry }}/$REPOSITORY:${{ github.sha }} ./test.sh

    - name: Push docker image
      run: |
        docker push ${{ steps.login-ecr.outputs.registry }}/$REPOSITORY:${{ github.sha }}

  cdk-deploy:
    runs-on: ubuntu-latest
    needs: build-test-push
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
      - name: cdk deploy
        uses: tj-actions/aws-cdk@v4
        with:
          cdk_subcommand: "deploy"
          cdk_stack: "TestAppStack"
          cdk_extra_args: >-
            --progress events
            --require-approval never
            --context repositoryArn=arn:aws:ecr:sa-east-1:807181840404:repository/matific/test-app
            --context tag=${{ github.sha }}
